---
title: "Anthropause initial sound pressure and weather data exploration"
author: "Philina English"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
if (!require(tidyverse)) install.packages("tidyverse"); library(tidyverse)
if (!require(lubridate)) install.packages("lubridate"); library(lubridate)
if (!require(EnvStats)) install.packages("EnvStats") 
if (!require(devtools)) install.packages("devtools")
if (!require(gfplot)) devtools::install_github("pbs-assess/gfplot")

theme_set(gfplot:::theme_pbs())

# all sound pressure data pooled by hr
# splhr <- readRDS("wdata/splbyhour.rds") 

# sound pressure and weather data 
daily <- readRDS(here::here("wdata/trimmed_daily_weather.rds"))
hourly <- readRDS(here::here("wdata/trimmed_hourly_weather.rds"))

hourly$hrseq <- ((as.numeric(hourly$datehr) - min(as.numeric(hourly$datehr))+ 3600)/3600)  
hourly$hrseq
hourly$hrseq.f <- as.factor((as.numeric(hourly$datehr) - min(as.numeric(hourly$datehr))+ 3600)/3600)  
hourly$hr.c <- (hourly$hr)-12
hourly$spl50
```

```{r eval = FALSE, include = FALSE}
daily %>% 
  ggplot(aes(y = wspeed, x = as.factor(year), color = as.factor(year))) +
  geom_violin() +
  geom_point(alpha =0.2) +
  facet_grid(rca~period, scales = "free")

hourly %>% 
  ggplot(aes(y = wspeed, x = as.factor(year), color = as.factor(year))) +
  geom_violin() +
  geom_jitter(alpha =0.2) +
  facet_grid(rca~period, scales = "free")
```

```{r eval = FALSE, include = FALSE}
# daily %>% glimpse()
hourly %>% glimpse()
```

```{r}
hist(hourly$spl50, breaks = 20)
```

```{r}
hourly %>% 
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), fill = as.factor(year))) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_wrap(~rca) +
  xlab ("Wind speed") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape at night ('out' is closer to shore)")
```


## Check for effect of wind speed at quietest time of night
Noisier at RCA out... maybe because closer to shore?

```{r}
# wind speed at night 
hourly %>% filter(
  hr < 4 & hr > 0
) %>%
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), fill = as.factor(year))) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_wrap(~rca) +
  xlab ("Wind speed") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape at night ('out' is closer to shore)")
```

### Wind speed under 20 km/hr seems acceptable 
```{r}
# wind speed under 20 seems acceptable 
hourly %>% filter(
  # (hr < 4 | hr > 10),
  wspeed < 20 # ~ 10 knots
  ) %>%
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), fill = as.factor(year))) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(rca~period, scales = "free")+
  xlab ("Wind speed") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape when wind speed <20 km/hr")
```

```{r}
hourly %>% filter(
  (hr < 4 | hr > 10), # at night only
  wspeed < 10 # ~ 5 knots
  ) %>%
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), fill = as.factor(year))) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(rca~period, scales = "free")+
  xlab ("Wind speed") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape at night when wind speed <10 km/hr")
```

## What time of day is noisiest?
```{r}
# time of day
hourly %>% filter(
  wspeed < 10 # ~ 5 knots
) %>%
  ggplot(aes(y = spl50, x = hr, color = as.factor(year), fill = as.factor(year))) +
  geom_smooth(method= "lm", formula = y~x + I(x^2)) +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(rca~period, scales = "free") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  xlab ("Time of day") +
  ylab("Median hourly sound pressure") +
  ggtitle("Changes through the day when wind speed <10 km/hr")
```

```{r }
hourly %>% filter(
  wspeed < 20 # ~ 10 knots
) %>%
  ggplot(aes(y = spl50, x = hr, color = as.factor(year), fill = as.factor(year))) +
  geom_smooth(method= "lm", formula = y~x + I(x^2)) +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(rca~period, scales = "free") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  xlab ("Time of day") +
  ylab("Median hourly sound pressure") +
  ggtitle("Changes through the day when wind speed <20 km/hr")
```

## Boxplots
```{r}
# boxplot
hourly %>% filter(
  # hr >= 9 & hr <= 17, # between 9-5; busiest
  # hr < 4 & hr > 2, # between 2-4 am; quietest 
  wspeed < 10
) %>%
  ggplot(aes(y = spl50, x = as.factor(period), color = as.factor(year))) +
  # geom_violin() +
  geom_boxplot() +
  EnvStats::stat_n_text(y.pos = 32, alpha = 0.5) + 
  # geom_jitter(alpha=0.2) +
  facet_wrap(~rca, nrow = 2) +
  # facet_wrap(~grp, nrow = 2) +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  xlab("Time period") +
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape differences with COVID when wind < 10 km/hr")
```

```{r}
# boxplot
hourly %>% filter(
  # hr >= 9 & hr <= 17, # between 9-5; busiest
  hr < 4 & hr > 0, # between 2-4 am; quietest
  wspeed < 10
) %>%
  ggplot(aes(y = spl50, x = as.factor(period), color = as.factor(year), fill = as.factor(year))) +
  # # geom_violin() +
  #  geom_violin(aes(y = spl95, x = as.factor(period), colour = as.factor(year)), inherit.aes = F) +
  #  geom_violin(aes(y = spl05, x = as.factor(period), colour = as.factor(year)), inherit.aes = F) +
   geom_boxplot(alpha = 0.5) +
  EnvStats::stat_n_text(y.pos = 28, alpha = 0.5) + 
  # geom_jitter(alpha=0.2) +
  facet_wrap(~rca, nrow = 2) +
  # facet_wrap(~grp, nrow = 2) +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  # scale_fill_discrete(name= "Year") +
  # scale_colour_discrete(name= "Year") + 
  xlab("Time period") +
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape nighttime differences with COVID when wind < 10 km/hr")
```
## Busiest time of day
```{r}
# boxplot
hourly %>% filter(
  hr >= 9 & hr <= 17, # between 9-5; busiest
  # hr < 4 & hr > 2, # between 2-4 am; quietest 
  wspeed < 10
) %>%
  ggplot(aes(y = spl50, x = as.factor(period), color = as.factor(year))) +
  # geom_violin() +
  geom_boxplot( outlier.alpha = 0) +
  EnvStats::stat_n_text(y.pos = 28, alpha = 0.5) + 
  geom_point(position = position_jitterdodge(), alpha=0.2) +
  facet_wrap(~rca, nrow = 2) +
  # facet_wrap(~grp, nrow = 2) +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  xlab("Time period") +
  ylab("Median hourly sound pressure") +
  ggtitle("Soundscape daytime differences with COVID when wind < 10 km/hr")
```

## Explore the effect of wind direction at both sites
All directions also noisier at RCA out
But hopefully we can ignore direction if calm 

```{r}

hourly %>% filter(
  wspeed > 10 # ~ 5 knots
) %>% 
  # mutate(wdirN = wdir-27, wdirN = if_else(wdirN == - 18, 0, wdirN)) %>%
  ggplot(aes(y = spl50, x = wdir)) +
  geom_smooth(method= "lm", formula = y~x + I(x^2)) +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(rca~period, scales = "free") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  # xlab ("Time of day") +
  ylab("Median hourly sound pressure") +
  ggtitle("Changes with wind direction")
```


```{r}
# N or NW winds
hourly %>% filter(
  #wspeed < 10, 
  hr < 7,
  wdir == 1 |  wdir >= 32) %>% # effects both equally
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), group = grp)) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(~rca, scales = "free") +  
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ggtitle("N or NW winds")

# NE or E winds are rare
hourly %>% filter(  
  hr < 7,
  wdir > 1 & wdir < 13) %>%
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), group = grp)) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(~rca, scales = "free") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ggtitle("NE or E winds are rare")

# SE winds
hourly %>% filter(#wspeed < 10, 
  hr < 7,
  wdir >= 13 & wdir < 18) %>% # appears to effect RCA in most
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), group = grp)) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(~rca, scales = "free") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ggtitle("SE winds")

# SW OR W winds
hourly %>% filter(
  #wspeed < 10, 
  hr < 7,
  wdir >= 18 & wdir < 32) %>% # appears to effect RCA in most
  ggplot(aes(y = spl50, x = wspeed, color = as.factor(year), group = grp)) +
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.2, size = 2) +
  facet_grid(~rca, scales = "free") +
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  ggtitle("SW OR W winds")
```

# ANOVA
```{r}
m <- aov(spl50 ~ 
    position + # unique intercepts for each location 
    period * as.factor(year) +# time variables interacting?
    period * rca # site difference might vary seasonally?
  , data = filter(hourly, wspeed < 20))
summary(m)
```

```{r}
m <- aov(spl50 ~ 
    period * as.factor(year) + # year and postition are confounded
    period * rca # site difference might vary seasonally?
  , data = filter(hourly, wspeed < 20))
summary(m)
TukeyHSD(m)
```


# ANCOVA
```{r}
# add daily curve 
m <- lm(spl50 ~ poly(hr, 2) + period * as.factor(year) + period * rca, 
  data = filter(hourly, wspeed < 20))
summary(m)
```

but the shape of daily curve does interact with year and period
```{r}
# but the shape of daily curve does interact with year and period
m <- lm(spl50 ~ poly(hr, 2) * period * as.factor(year) + period * rca, 
  data = filter(hourly, wspeed < 20))
summary(m)
```

so extract noisiest period only 
```{r}
# so extract noisiest period only 
m <- lm(spl50 ~ period * as.factor(year) + period * rca
  , data = filter(hourly, wspeed < 10 & hr >= 9 & hr <= 17))
summary(m)
```

What about the quietest 5th?
```{r}
m <- lm(spl05 ~ period * as.factor(year) + period * rca
  , data = filter(hourly, wspeed < 10 & hr >= 9 & hr <= 17))
summary(m)
```

What about the noisiest 5th?
```{r}
m <- lm(spl95 ~ period * as.factor(year) + period * rca
  , data = filter(hourly, wspeed < 10 & hr >= 9 & hr <= 17))
summary(m)
```


Time continuous plot
In full data set there is some temporal autocorrelation that we would need to control for
```{r}
hourly %>% 
ggplot(aes(y=spl50, x=mdh, color=as.factor(year), group=grp))+
  geom_point(alpha = 0.5, size = 0.5)+
  geom_line(alpha = 0.5)+
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  coord_cartesian(ylim = c(90, 120))+
  facet_grid(rca~period, scales="free") +
  xlab("Time")
```

Still quite a bit in the daytime low wind version 
```{r}
hourly %>% filter( 
  wspeed < 20 & hr >= 9 & hr <= 17
  ) %>%
ggplot(aes(y=spl50, x=mdh, color=as.factor(year), group=grp))+
  geom_point(alpha = 0.8)+
  geom_line(alpha = 0.2)+
  scale_fill_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+ #"#E7B800",
  scale_color_manual(name= "Year",values = c("#FC4E07", "#00AFBB"))+
  coord_cartesian(ylim = c(90, 120))+
  facet_grid(rca~period, scales="free") +
  xlab("Time")
```



# Control for potential differences in each drop using mixed model

```{r}
m <- lmerTest::lmer(spl50 ~ 0 + period * as.factor(year) + rca + (1|position) + (1|ymdh)
  , data = filter(hourly, wspeed < 20 
    # & hr >= 9 & hr <= 17
    ))
summary(m)
```

Add in windy times, while controling for wind speed to increase sample size
Now all periods are significant!
```{r}
m <- lmerTest::lmer(spl50 ~ 0 + period * as.factor(year) + rca * wspeed + (1|position) + (1|ymdh) #+ (1|md)
  , data = filter(hourly, wspeed < 40 & hr >= 9 & hr <= 17))
summary(m)
```

### Are quietest times quieter?
```{r}
m <- lmerTest::lmer(spl05 ~ 0 + period * as.factor(year) + rca + (1|position)+ (1|md), 
  # data = filter(hourly, wspeed < 20 & hr >= 9 & hr <= 17))
  data = filter(hourly, wspeed < 20 & hr < 4 & hr > 0))
summary(m)
```

### Are noisiest times quieter? 
Not significantly
```{r}
m <- lmerTest::lmer(spl95 ~ period * as.factor(year) + rca + (1|position) + (1|md)
  , data = filter(hourly, wspeed < 20 & hr >= 9 & hr <= 17))
summary(m)
```


### TRY WITH TEMPORAL AR1

```{r}
mAR1 <- glmmTMB::glmmTMB(spl95 ~ period * as.factor(year) + 
    # period * rca +  
    # as.factor(year) * rca + 
    (1|position) +  
    (1|rca) +
    # ar1(datehr-1|rca),
    # ar1(ymdh-1|rca),    
    ar1(ymdh-1|position),
  data = filter(hourly, wspeed < 20), family=gaussian)

summary(mAR1)
# brms::brm(mAR1)
```



```{r}

mAR1 <- glmmTMB::glmmTMB(spl50 ~ period * as.factor(year) + wspeed +
        poly(hr.c, 2) +
    # period * rca +  
    # as.factor(year) * rca + 
    (1|position) +  
    (1|rca) +
    # ar1(datehr-1|rca),
    # ar1(ymdh-1|rca),    
    ar1(hrseq.f-1|position),  
    # ar1(ymdh-1|position),
  data = filter(hourly, wspeed < 20), family=gaussian)

summary(mAR1)
# brms::brm(mAR1)
```


```{r}
mAR1$frame$resid <- residuals(mAR1)
mAR1$frame$est <- predict(mAR1)

ggplot(filter(mAR1$frame), aes(est, resid)) + geom_point(alpha = 0.2)  + geom_smooth() 
  # facet_grid(period~year.f)
```


```{r}
apr2019 <- mAR1$fit$par[[1]]
may2019 <- mAR1$fit$par[[1]]+mAR1$fit$par[[2]]
june2019 <- mAR1$fit$par[[1]]+mAR1$fit$par[[3]]

apr2020 <- mAR1$fit$par[[1]]+mAR1$fit$par[[4]]
may2020 <- mAR1$fit$par[[1]]+mAR1$fit$par[[2]]+mAR1$fit$par[[4]]+mAR1$fit$par[[8]]
june2020 <- mAR1$fit$par[[1]]+mAR1$fit$par[[3]]+mAR1$fit$par[[4]]+mAR1$fit$par[[9]]


```

% drop from 2019 in sound pressure levels (dB) during BC covid shutdown Phase I

```{r}
100 - round((apr2020/apr2019)*100)
```

rebound to % of 2019 sound pressure levels during BC covid shutdown early Phase II

```{r}
round((may2020/may2019)*100)
```

rebound to % of 2019 sound pressure levels during BC covid shutdown late Phase II

```{r}
round((june2020/(june2019))*100)
```

Doesnt't converge with all data and wind speed as covariate with random slopes

Can add in all wind speeds but residuals look pretty bad...

```{r eval = T}
hourly2 <- hourly %>% select(-wdir) %>% drop_na()
hourly2$year.f <- as.factor(hourly2$year)

mAR1 <- glmmTMB::glmmTMB(spl50 ~ period * year.f + wspeed + 
    # poly(wspeed, 2) + 
    poly(hr.c, 2) +
    (1|rca) +
    # (poly(wdir, 2)|rca) + # missing values?
    # (poly(hr.c, 2)|rca) +
    # (poly(wspeed, 2)|rca) +
    # us(hrseq.f-1|position),  # crashes R
    ar1(hrseq.f-1|position),  
    # ar1(ymdh-1|position),
  data = filter(hourly2), 
  # REML = T,
  family=gaussian)
```

```{r}
summary(mAR1)
```

```{r}
mAR1$frame$resid <- residuals(mAR1)
mAR1$frame$est <- predict(mAR1)

ggplot(filter(mAR1$frame), aes(est, resid)) + geom_point(alpha = 0.2)  + geom_smooth() + 
  facet_wrap(~year.f)
  # facet_grid(period~year.f)
```

